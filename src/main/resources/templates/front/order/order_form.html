<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{front/layouts/main}">
<main class="max-w-screen-lg ma" layout:fragment="content">
    <h1 th:text="#{주문서_작성}"></h1>

    <form name="frmOrder" method="post" th:action="@{/order}" autocomplete="off" th:object="${cartData}">
        <input type="hidden" name="totalPrice" th:field="*{totalPrice}">
        <input type="hidden" name="totalDeliveryPrice" th:field="*{totalDeliveryPrice}">
        <input type="hidden" name="totalDiscount" th:field="*{totalDiscount}">
        <input type="hidden" name="cartType" th:field="${cartType}">

        <h2 th:text="#{주문_상품}"></h2>

        <th:block th:replace="~{front/cart/_items::items}"></th:block>
        <div class="error global" th:each="err : ${#fields.globalErrors()}" th:text="${err}"></div>
        <div th:object="${requestOrder}">
            <h2 th:text="#{주문자_정보}"></h2>

            <table class="table_order">
                <tr>
                    <th th:text="#{주문자_이름}"></th>
                    <th:block th:if="${@memberUtil.isLogin()}">
                        <td>
                            <input type="text" name="orderName" th:value="${session.member.username}" readonly id="orderName">
                        </td>
                    </th:block>
                    <th:block th:unless="${@memberUtil.isLogin()}">
                        <td>
                            <input type="text" name="orderName" id="orderName" th:field="*{orderName}">
                            <div class="error" th:if="${#fields.hasErrors('orderName')}" th:each="err : ${#fields.errors('orderName')}" th:text="${err}"></div>
                        </td>
                    </th:block>
                </tr>
                <tr>
                    <th th:text="#{휴대전화번호}"></th>
                    <th:block th:if="${@memberUtil.isLogin()}">
                        <td>
                            <input type="text" name="orderCellPhone" th:value="${session.member.tel}" readonly id="orderCellPhone" oninput="autoHyphen(this)">
                        </td>
                    </th:block>
                    <th:block th:unless="${@memberUtil.isLogin()}">
                        <td>
                            <input type="text" name="orderCellPhone" id="orderCellPhone" oninput="autoHyphen(this)" th:field="*{orderCellPhone}">
                            <div class="error" th:each="err : ${#fields.errors('orderCellPhone')}" th:text="${err}"></div>
                        </td>
                    </th:block>
                </tr>

                <tr>
                    <th th:text="#{이메일}"></th>
                    <th:block th:if="${@memberUtil.isLogin()}">
                        <td>
                            <input type="text" name="orderEmail" th:value="${session.member.email}" readonly id="orderEmail">
                        </td>
                    </th:block>
                    <th:block th:unless="${@memberUtil.isLogin()}">
                        <td>
                            <input type="text" name="orderEmail" id="orderEmail" th:field="*{orderEmail}">
                            <div class="error" th:each="err : ${#fields.errors('orderEmail')}" th:text="${err}"></div>
                        </td>
                    </th:block>
                </tr>

            </table>

            <h2 th:text="#{받는분_정보}"></h2>
            <table class="table_order">
                <input type="checkbox" name="eqOrder" id="eqOrder">
                <label for="eqOrder" th:text="#{주문자와_동일}"></label>
                <tr>
                    <th th:text="#{받는분_이름}"></th>
                    <td>
                        <input type="text" name="receiverName" id="receiverName" th:field="*{receiverName}">
                        <div class="error" th:each="err : ${#fields.errors('receiverName')}" th:text="${err}"></div>
                    </td>
                </tr>
                <tr>
                    <th th:text="#{휴대전화번호}"></th>
                    <td>
                        <input type="text" name="receiverCellPhone" id="receiverCellPhone" oninput="autoHyphen(this)" th:field="*{receiverCellPhone}">
                        <div class="error" th:each="err : ${#fields.errors('receiverCellPhone')}" th:text="${err}"></div>
                    </td>
                </tr>
                <tr>
                    <th th:text="#{배송_주소}"></th>
                    <td th:if="${addr != null}"}>
                        <div class="address_rows">
                            <input type="text" name="zoneCode" th:placeholder="#{우편번호}" readonly id="zonecode" th:value="${addr.zoneCode}">
                            <div class="error" th:each="err : ${#fields.errors('zoneCode')}" th:text="${err}"></div>
                            <button type="button" class="search_address" data-zonecode-id="zonecode" data-address-id="address">
                                <i class="xi-search"></i>
                                <th:block th:text="#{주소_찾기}"></th:block>
                            </button>
                        </div>

                        <div class="address_rows">
                            <input type="text" name="address" th:placeholder="#{주소}" readonly id="address" th:value="${addr.address}">
                            <div class="error" th:each="err : ${#fields.errors('address')}" th:text="${err}"></div>
                        </div>

                        <div class="address_rows">
                            <input type="text" name="addressSub" th:pleaceholder="#{나머지_주소}" th:value="${addr.addressSub}">
                        </div>
                    </td>
                    <td th:unless="${addr != null}"}>
                        <div class="address_rows">
                            <input type="text" name="zoneCode" th:placeholder="#{우편번호}" readonly id="zonecode" th:field="*{zoneCode}">
                            <div class="error" th:each="err : ${#fields.errors('zoneCode')}" th:text="${err}"></div>
                            <button type="button" class="search_address" data-zonecode-id="zonecode" data-address-id="address">
                                <i class="xi-search"></i>
                                <th:block th:text="#{주소_찾기}"></th:block>
                            </button>
                        </div>

                        <div class="address_rows">
                            <input type="text" name="address" th:placeholder="#{주소}" readonly id="address" th:field="*{address}" >
                            <div class="error" th:each="err : ${#fields.errors('address')}" th:text="${err}"></div>
                        </div>

                        <div class="address_rows">
                            <input type="text" name="addressSub" th:pleaceholder="#{나머지_주소}" th:field="*{addressSub}">
                        </div>
                    </td>
                </tr>

                <tr>
                    <th th:text="#{배송_메세지}"></th>
                    <td>
                        <input type="text" name="deliveryMemo">
                    </td>
                </tr>
            </table>

            <h2 th:text="#{결제_정보}"></h2>
            <table class="table_order">
                <tr>
                    <th th:text="#{상품합계}"></th>
                    <td>
                        <span class="money" id="total_price" th:text="${cartData.totalPrice}"></span>
                        <th:block th:text="#{돈단위}"></th:block>
                    </td>
                </tr>
                <tr>
                    <th th:text="#{배송비}"></th>
                    <td>
                        <th:block th:if="${cartData.totalDeliveryPrice > 0}">
                            <span class="money" th:text="${cartData.totalDeliveryPrice}"></span>
                            <th:block th:text="#{돈단위}"></th:block>
                        </th:block>
                        <th:block th:unless="${cartData.totalDeliveryPrice > 0}" th:text="#{무료배송}"></th:block>
                    </td>
                </tr>

                <tr th:if="${cartData.totalDiscount > 0}">
                    <th th:text="#{상품할인}"></th>
                    <td>
                        <span class="money" th:text="${cartData.totalDiscount * -1}"></span>
                        <th:block th:text="#{돈단위}"></th:block>
                    </td>
                </tr>

                <tr th:if="${@memberUtil.isLogin()}">
                    <th th:text="#{포인트_사용}"></th>
                    <td>
                        <span th:text="#{보유포인트}"></span>
                        :
                        <span id="avail_point" class="money" th:text="${point}"></span><br/>
                        <input type="number" name="usePoint" min="0" id="use_point" th:field="*{usePoint}">
                        <div class="error" th:each="err : ${#fields.errors('usePoint')}" th:text="${err}"></div>
                        <button type="button" id="pointBtn" class="sbtn" th:text="#{적용하기}"></button>
                        <div class="auth_box"></div>
                    </td>
                </tr>

                <tr>
                    <th th:text="#{결제금액}"></th>
                    <td>
                        <span id="pay_price" class="money" th:text="${cartData.payPrice}"></span>
                        <th:block th:text="#{돈단위}"></th:block>
                    </td>
                </tr>
                <tr>
                    <th th:text="#{결제약관_동의}"></th>
                    <td>
                        <textarea th:text="${paymentConfig.personalInfoEntrust}" readonly></textarea>
                        <input type="checkbox" value="true" name="agree" id="agree" th:field="*{agree}">
                        <label for="agree" th:text="#{동의}"></label>
                        <div class="error" th:each="err : ${#fields.errors('agree')}" th:text="${err}"></div>
                    </td>
                </tr>
            </table>
        </div>
        <button type="button" id="paymentButton">결제하기</button>
    </form>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
    <script>

        const productNames = document.querySelector(".product_name");
        let prName = '';

        if(Array.isArray(productNames)){
            prName = productNames[0].innerText + '외 ' + (productNames.length() - 1) + '건';
        }else{
            prName = productNames.innerText;
        }



        const payPrice = document.querySelector("#pay_price");
        const finalPrice = Number(payPrice.innerText.replace(/\,/g, ''));

        $(document).ready(function(){
            // 버튼을 클릭했을 때 실행될 함수
            $("#paymentButton").click(function(){
                var IMP = window.IMP; // 생략가능
                IMP.init('iamport'); // 'iamport' 대신 부여받은 "가맹점 식별코드"를 사용
                var msg;

                IMP.request_pay({
                    pg : 'kakaopay',
                    pay_method : 'card',
                    merchant_uid : 'merchant_' + new Date().getTime(),
                    name : prName,
                    amount : finalPrice,
                    buyer_email : 'gg',
                    buyer_name : 'gg',
                    buyer_tel : '33',
                    buyer_addr : 'gg',
                    buyer_postcode : '123-456',
                    //m_redirect_url : 'http://www.naver.com'
                }, function(rsp) {
                    if ( rsp.success ) {
                        //[1] 서버단에서 결제정보 조회를 위해 jQuery ajax로 imp_uid 전달하기
                        jQuery.ajax({
                            url: "/payments/complete", //cross-domain error가 발생하지 않도록 주의해주세요
                            type: 'POST',
                            dataType: 'json',
                            data: {
                                imp_uid : rsp.imp_uid
                                //기타 필요한 데이터가 있으면 추가 전달
                            }
                        }).done(function(data) {
                            //[2] 서버에서 REST API로 결제정보확인 및 서비스루틴이 정상적인 경우
                            if ( everythings_fine ) {
                                msg = '결제가 완료되었습니다.';
                                msg += '\n고유ID : ' + rsp.imp_uid;
                                msg += '\n상점 거래ID : ' + rsp.merchant_uid;
                                msg += '\결제 금액 : ' + rsp.paid_amount;
                                msg += '카드 승인번호 : ' + rsp.apply_num;

                                alert(msg);
                            } else {
                                //[3] 아직 제대로 결제가 되지 않았습니다.
                                //[4] 결제된 금액이 요청한 금액과 달라 결제를 자동취소처리하였습니다.
                            }
                        });
                        //성공시 이동할 페이지
                        location.href='/order/paySuccess?msg='+msg;
                    } else {
                        //실패시 이동할 페이지
                        location.href="/order/payFail";
                    }
                });
            });
        });
    </script>
</main>
</html>